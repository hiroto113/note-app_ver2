# Note風学習記録サイト 設計書

## ドキュメント管理ルール

**注：ドキュメント構成の詳細はCLAUDE.mdの「Documentation Structure」セクションを参照**

### 1. 更新ルール
- 設計変更は必ず`design.md`に反映
- 開発プロセスの変更は`development.md`に反映
- 変更履歴は各ファイルの末尾に記録
- コミットメッセージには変更内容を明確に記述
- ドキュメント更新はIssueとして管理（`[docs]`プレフィックス使用）
- ドキュメント更新PRは`docs/`ブランチを使用

### 2. レビュープロセス
- 設計変更は必ずレビューを実施
- レビュー担当者（自分）はドキュメントの整合性を確認
- 承認後にメインブランチにマージ
- GitHub Pull Requestを通じてレビューを実施
- レビュー時は以下を確認：
  - 設計との整合性
  - 記述の明確さ
  - フォーマットの統一性
  - 関連ドキュメントとの一貫性

### 3. バージョン管理
- GitHubでのバージョン管理を実施
- 重要な設計変更は個別のタグを付与
- リリースノートに設計変更を記録
- ドキュメントの変更履歴はGitHubで追跡可能に

### 4. ドキュメント形式
- Markdown形式で記述
- 見出しレベルは階層的に使用（h1 > h2 > h3）
- コードブロックは適切な言語指定
- 図表はMermaid記法を使用
- リンクは相対パスで記述

### 5. Issue管理
- ドキュメント更新提案は専用のIssueテンプレートを使用
- 更新の優先度をラベルで管理
- マイルストーンと紐付けて進捗管理
- 関連するコード変更とIssueをリンク

---

# 1. 背景と目的

- このアプリケーションは、AI×開発に関する学習記録と得られた知見をブログ形式で公開・共有するWebサイトを提供します。
- 対象ユーザーは、AI開発に興味を持つ開発者やエンジニアです。
- 運用者（著者）は、Cursorを活用してAIと対話しながら効率的にコンテンツを作成・更新することを想定しています。

# 2. システムアーキテクチャ

```mermaid
graph TD
    subgraph "ユーザー"
        A[閲覧者]
        G[管理者/著者]
    end

    subgraph "システム (SvelteKit)"
        subgraph "フロントエンド"
            B[閲覧用UI<br/>(記事一覧, 詳細)]
            H[管理画面UI<br/>(ログイン, 記事CRUD)]
        end

        subgraph "バックエンド (API Routes)"
            subgraph "公開用API (/api)"
                K[記事取得API (GET)]
            end
            subgraph "管理用API (/api/admin)"
                L[記事CRUD API (GET, POST, PUT, DELETE)]
                M[認証API (POST)]
            end
        end

        B -->|データ取得| K
        H -->|データ操作| L
        G -->|ログイン| M
    end

    subgraph "永続層"
        D[(データベース SQLite)]
    end

    K -->|ORM| D
    L -->|ORM| D
    A -->|アクセス| B
    G -->|アクセス| H
```

## 2.1 ファイル構成案
以下に、管理画面機能の導入を想定したディレクトリ構成案を示します。SvelteKitのルーティング規約に基づき、機能ごとにディレクトリを分離します。

```text
src/
├── hooks.server.ts      # サーバーサイドフック（認証処理など）
├── auth.ts              # Auth.js の設定ファイル
├── lib/
│   ├── components/      # 共通UIコンポーネント
│   ├── server/          # サーバーサイド専用モジュール
│   │   └── db/
│   │       ├── index.ts # DBクライアントのインスタンス化
│   │       └── schema.ts# DBテーブルスキーマ定義
│   └── types/           # 型定義
│       └── index.ts
└── routes/
    ├── (public)/        # 認証不要の公開ページグループ
    │   ├── +layout.svelte
    │   ├── +page.svelte     # トップページ（記事一覧）
    │   └── posts/
    │       └── [slug]/
    │           └── +page.svelte # 記事詳細ページ
    ├── (admin)/         # 要認証の管理ページグループ
    │   ├── +layout.svelte # 管理画面共通レイアウト・認証チェック
    │   └── admin/
    │       ├── +page.svelte     # 管理画面トップ
    │       ├── posts/
    │       │   ├── +page.svelte     # 記事管理ページ（一覧）
    │       │   ├── new/
    │       │   │   └── +page.svelte # 新規記事作成ページ
    │       │   └── [id]/edit/
    │       │       └── +page.svelte # 記事編集ページ
    │       └── categories/
    │           └── +page.svelte     # カテゴリ管理ページ
    ├── login/           # ログインページ
    │   └── +page.svelte
    └── api/
        ├── posts/           # 公開用API
        │   ├── +server.ts     # GET: 記事一覧
        │   └── [slug]/
        │       └── +server.ts # GET: 個別記事
        └── admin/
            ├── posts/       # 管理用API
            │   ├── +server.ts # GET: 全記事一覧, POST: 新規作成
            │   └── [id]/
            │       └── +server.ts # PUT: 更新, DELETE: 削除
            └── auth/
                └── [...]            # Auth.jsがハンドルする認証エンドポイント
```

# 3. 機能要件

## 3.1 記事管理機能
- **機能概要**: 管理画面を通じて、記事の作成・編集・削除を行えるようにする。
- **管理者認証**:
  - ログイン機能を提供し、認証されたユーザーのみ管理画面にアクセスできる。
- **記事のCRUD操作**:
  - **作成 (Create)**: 新しい記事をタイトル、内容、カテゴリなどを入力して作成できる。
  - **一覧表示 (Read)**: 公開・非公開状態を含むすべての記事を一覧で確認できる。
  - **編集 (Update)**: 既存の記事の内容やメタデータを更新できる。
  - **削除 (Delete)**: 記事を削除できる。

## 3.2 ページ表示機能
- **機能概要**：各種ページを適切なレイアウトで表示します。
- **共通機能**：
  - レスポンシブデザイン対応
  - パンくずリスト表示
  - SNSシェアボタン
- **ページ固有機能**：
  - TOPページ：最新記事一覧、カテゴリー一覧
  - 学習ログページ：時系列での学習記録表示
  - 記事詳細ページ：本文表示、目次表示

## 3.3 SEO対策機能
- **機能概要**：検索エンジン最適化のための各種対策を実装します。
- **実装内容**：
  - メタタグの適切な設定
  - OGP対応
  - サイトマップ自動生成
  - 構造化データ（JSON-LD）対応

## 3.4 アクセス解析機能
- **機能概要**：Google Analyticsを用いたアクセス解析を実装します。
- **計測項目**：
  - ページビュー数
  - 滞在時間
  - 流入元
  - ユーザー属性

# 4. 非機能要件

## 4.1 パフォーマンス要件
- **Lighthouse スコア**
  - Performance: 90以上
  - Accessibility: 90以上
  - Best Practices: 90以上
  - SEO: 90以上

## 4.2 UIデザイン要件
- Note風のミニマルなデザイン
- Tailwind CSSを利用
- ダークモード対応
- レスポンシブ対応（PC、タブレット、スマートフォン）

## 4.3 アクセシビリティ要件
- WAI-ARIA対応
- キーボード操作対応

## 4.4 SEO要件
- 適切なHTML構造
- メタデータの最適化
- パフォーマンス最適化

# 5. 技術スタック

## 5.1 フロントエンド
- SvelteKit
- Tailwind CSS
- MDsveX（Markdown処理）

## 5.2 バックエンド
- SvelteKit (Node.js)
- SQLite
- Auth.js (認証)

## 5.3 開発環境
- Cursor IDE
- Git/GitHub

# 6. デプロイ・運用方針

## 6.1 デプロイ環境
### 推奨：Vercel
- **メリット**：
  - SvelteKitとの高い親和性
  - 自動デプロイの容易な設定
  - 優れたパフォーマンスと信頼性
  - 無料枠が十分
  - エッジネットワークによる高速配信
- **デメリット**：
  - SQLiteの永続化に追加設定が必要
  - 無料枠を超えた場合のコストが比較的高い

## 6.2 バックアップ戦略
### GitHub + 外部ストレージの併用
- **コンテンツバックアップ**
  - GitHubでのバージョン管理
  - Google Driveでの定期バックアップ（月1回）

# 7. エラーハンドリング方針

## 7.1 階層的エラーハンドリング
1. **アプリケーションレベル**
   - グローバルエラーハンドラーの実装
   - エラーページの用意（404, 500など）
   - エラーログの収集

2. **コンポーネントレベル**
   - try-catchによるエラー捕捉
   - エラー状態のUI表示
   - ユーザーフレンドリーなエラーメッセージ

3. **ロギング**
   - 開発環境：詳細なログ
   - 本番環境：重要なエラーのみ
   - セキュリティに関わる情報の適切な扱い

# 8. 環境分離方針

## 8.1 環境構成
1. **開発環境（Development）**
   - ローカル環境
   - 開発用データ
   - デバッグモード有効

2. **テスト環境（Staging）**
   - Vercel Preview Deployments活用
   - テストデータ
   - 本番相当の設定

3. **本番環境（Production）**
   - Vercel Production環境
   - 本番データ
   - 最適化設定有効

## 8.2 環境変数管理
- `.env`ファイルによる環境ごとの設定
- 機密情報はVercelのEnvironment Variables利用

# 9. セキュリティ方針
- CSPの適切な設定
- XSS対策の徹底
- 適切なCORS設定

# 10. データモデル

## 10.1 記事テーブル (Posts)
- id: `INTEGER` (主キー)
- slug: `TEXT` (URL用スラッグ、ユニーク)
- title: `TEXT`
- content: `TEXT` (記事本文、Markdown形式)
- status: `TEXT` ('published', 'draft')
- publishedAt: `DATETIME`
- createdAt: `DATETIME`
- updatedAt: `DATETIME`

## 10.2 カテゴリテーブル (Categories)
- id: `INTEGER` (主キー)
- name: `TEXT` (カテゴリ名、ユニーク)

## 10.3 記事・カテゴリ中間テーブル (PostsCategories)
- postId: `INTEGER` (外部キー)
- categoryId: `INTEGER` (外部キー)

## 10.4 認証関連テーブル (Auth.js)
- `Auth.js` の `@auth/drizzle-adapter` が要求するスキーマに準拠する。
- **users**: ユーザー情報
- **accounts**: OAuthアカウント情報
- **sessions**: セッション情報
- **verificationTokens**: メール認証などのトークン情報

# 変更履歴
- 2024-06-05: 初版作成
- 2024-06-05: ドキュメント管理ルールを追加
- 2024-06-05: GitHub関連のドキュメント管理ルールを追加
- 2024-06-18: 管理画面導入に伴いシステムアーキテクチャ、機能要件、データモデルを更新
- 2024-06-19: 認証ライブラリをLuciaからAuth.jsに変更。それに伴い関連記述を修正。 