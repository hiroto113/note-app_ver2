# Phase 4-3: リッチテキストエディタ統合 詳細設計書

## 1. 概要
記事作成・編集機能にリッチテキストエディタを統合し、より効率的で直感的なコンテンツ作成環境を提供する。Markdownベースでありながら、WYSIWYG的な編集体験を実現する。

## 2. エディタ選定

### 2.1 採用エディタ: CodeMirror 6
- **理由**:
  - Markdownサポートが優秀
  - SvelteKit/Svelteとの親和性が高い
  - 軽量で高性能
  - プラグインエコシステムが充実
  - アクセシビリティサポート

### 2.2 代替案検討
- **TipTap**: 高機能だがBundle sizeが大きい
- **Monaco Editor**: 高機能だがブログ編集には過剰
- **Toast UI Editor**: 機能豊富だが日本語サポートが限定的

## 3. 実装仕様

### 3.1 エディタコンポーネント
- **ファイル**: `src/lib/components/editor/MarkdownEditor.svelte`
- **機能**:
  - Markdownシンタックスハイライト
  - リアルタイムプレビュー（サイドバイサイド）
  - ツールバー（太字、斜体、リンク、画像、コードブロックなど）
  - キーボードショートカット
  - ファイルドラッグ&ドロップ（将来拡張）

### 3.2 プレビューコンポーネント
- **ファイル**: `src/lib/components/editor/MarkdownPreview.svelte`
- **機能**:
  - MDsveXと同じレンダリング結果
  - シンタックスハイライト適用
  - 見出しアンカーリンク表示
  - 印刷プレビュー対応

### 3.3 ツールバーコンポーネント
- **ファイル**: `src/lib/components/editor/EditorToolbar.svelte`
- **機能**:
  - よく使う書式設定ボタン
  - 見出しレベル選択
  - リンク・画像挿入ダイアログ
  - プレビュー切り替えボタン

## 4. エディタ機能詳細

### 4.1 基本編集機能
```typescript
interface EditorFeatures {
  // テキスト書式
  bold: boolean;           // **太字**
  italic: boolean;         // *斜体*
  strikethrough: boolean;  // ~~取り消し線~~
  code: boolean;          // `インラインコード`
  
  // ブロック要素
  heading: 1 | 2 | 3 | 4 | 5 | 6;  // # 見出し
  blockquote: boolean;     // > 引用
  codeblock: boolean;      // ```コードブロック```
  list: 'ul' | 'ol';      // - リスト / 1. 番号付きリスト
  
  // リンク・メディア
  link: boolean;          // [テキスト](URL)
  image: boolean;         // ![alt](URL)
  
  // テーブル（将来拡張）
  table: boolean;         // | テーブル |
}
```

### 4.2 キーボードショートカット
```typescript
const shortcuts = {
  'Ctrl+B': 'bold',
  'Ctrl+I': 'italic',
  'Ctrl+K': 'link',
  'Ctrl+Shift+C': 'codeblock',
  'Ctrl+1': 'heading1',
  'Ctrl+2': 'heading2',
  'Ctrl+3': 'heading3',
  'Ctrl+P': 'preview-toggle',
  'Ctrl+S': 'save'
};
```

### 4.3 レイアウトモード
1. **エディタのみ**: 編集に集中
2. **サイドバイサイド**: 編集とプレビューを同時表示
3. **プレビューのみ**: 最終確認用

## 5. 統合方針

### 5.1 既存フォームとの統合
- `PostForm.svelte` にエディタコンポーネントを組み込み
- 従来のtextareaを `MarkdownEditor` で置き換え
- フォームバリデーションとの連携維持

### 5.2 データフロー
```svelte
<!-- PostForm.svelte -->
<MarkdownEditor 
  bind:value={postContent}
  placeholder="記事の内容を入力してください..."
  on:change={handleContentChange}
  on:save={handleSave}
/>
```

### 5.3 保存機能
- 自動保存（5秒間隔、デバウンス処理）
- 手動保存（Ctrl+S、保存ボタン）
- 下書き保存と公開の分離

## 6. UI/UXデザイン

### 6.1 エディタレイアウト
```
┌─────────────────────────────────────────┐
│ [B] [I] [🔗] [📷] [#] [<//>] [👁]        │ ← ツールバー
├─────────────────────────────────────────┤
│                    │                    │
│  # 記事タイトル      │   記事タイトル       │
│                    │                    │
│  ## 見出し2         │   見出し2            │
│                    │                    │
│  本文のテキストが... │   本文のテキストが... │
│                    │                    │
│  ```javascript     │   console.log();    │
│  console.log();    │                    │
│  ```              │                    │
│                    │                    │
│       編集          │     プレビュー       │
└─────────────────────────────────────────┘
```

### 6.2 レスポンシブ対応
- タブレット: 縦分割から横分割に切り替え
- スマートフォン: タブ切り替え（編集/プレビュー）

## 7. パフォーマンス最適化

### 7.1 レンダリング最適化
- プレビューの遅延レンダリング
- 大きなドキュメントの仮想スクロール
- Markdownパースのワーカー化（将来拡張）

### 7.2 Bundle Size最適化
- 必要な機能のみインポート
- Dynamic import による遅延読み込み
- CodeMirrorの軽量プラグイン選択

## 8. アクセシビリティ

### 8.1 キーボード操作
- 全機能のキーボードアクセス
- タブ順序の最適化
- ショートカットキーのカスタマイズ

### 8.2 スクリーンリーダー対応
- ツールバーボタンの適切なラベル
- エディタ状態の音声フィードバック
- プレビュー内容の読み上げ対応

## 9. 拡張機能（将来実装）

### 9.1 高度な編集機能
- テーブル編集サポート
- 数式入力（KaTeX統合）
- 図表作成（Mermaid統合）
- ファイルアップロード

### 9.2 協力編集機能
- リアルタイム同期編集
- コメント・レビュー機能
- 変更履歴・バージョン管理

## 10. 依存関係

### 10.1 必要なパッケージ
```json
{
  "codemirror": "^6.0.1",
  "@codemirror/lang-markdown": "^6.2.4",
  "@codemirror/theme-one-dark": "^6.1.2",
  "@codemirror/view": "^6.26.3",
  "@codemirror/state": "^6.4.1"
}
```

### 10.2 MDsveX連携
- プレビューでMDsveXと同じレンダリング結果を保証
- シンタックスハイライトの統一
- rehypeプラグインの共通化

## 11. テスト計画

### 11.1 機能テスト
- [ ] 基本的な編集機能が動作する
- [ ] ツールバーボタンが正しく機能する
- [ ] キーボードショートカットが動作する
- [ ] プレビューが正しく表示される
- [ ] 自動保存が機能する

### 11.2 パフォーマンステスト
- [ ] 大きなドキュメントでもスムーズに動作する
- [ ] プレビュー更新が遅延なく行われる
- [ ] メモリ使用量が適切な範囲内

### 11.3 アクセシビリティテスト
- [ ] キーボードのみで全操作が可能
- [ ] スクリーンリーダーで適切に読み上げられる
- [ ] 色覚多様性に配慮した表示

## 12. 関連ドキュメント
- Phase 4-1 記事管理UI: `doc/designs/phase-4/01_admin-posts-ui.md`
- Phase 2 MDsveX設定: `doc/designs/phase-2/01_mdsvex-setup.md`
- 全体設計: `doc/design.md`