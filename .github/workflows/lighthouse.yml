name: Lighthouse CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Lighthouse CIãŒå·®åˆ†ã‚’æ¯”è¼ƒã§ãã‚‹ã‚ˆã†å±¥æ­´ã‚’å–å¾—
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm run build
        env:
          # ãƒ“ãƒ«ãƒ‰æ™‚ã®ç’°å¢ƒå¤‰æ•°
          NODE_ENV: production
          
      - name: Start application
        run: |
          pnpm run preview &
          sleep 10
          curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:4173/
        timeout-minutes: 2
      
      - name: Run Lighthouse CI (Desktop)
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
      
      - name: Run Lighthouse CI (Mobile)
        run: |
          lhci autorun --config=lighthouserc.mobile.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
        continue-on-error: true
      
      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lighthouseçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const resultsPath = '.lighthouseci/lhr-*.json';
            const results = fs.readdirSync('.lighthouseci')
              .filter(file => file.startsWith('lhr-') && file.endsWith('.json'))
              .map(file => JSON.parse(fs.readFileSync(path.join('.lighthouseci', file), 'utf8')));
            
            if (results.length === 0) return;
            
            // ã‚¹ã‚³ã‚¢ã®å¹³å‡ã‚’è¨ˆç®—
            const avgScores = results.reduce((acc, result) => {
              const categories = result.categories;
              acc.performance += categories.performance.score * 100;
              acc.accessibility += categories.accessibility.score * 100;
              acc.bestPractices += categories['best-practices'].score * 100;
              acc.seo += categories.seo.score * 100;
              return acc;
            }, { performance: 0, accessibility: 0, bestPractices: 0, seo: 0 });
            
            const count = results.length;
            Object.keys(avgScores).forEach(key => {
              avgScores[key] = Math.round(avgScores[key] / count);
            });
            
            // PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            const comment = `## ğŸš€ Lighthouse CI Results
            
| Category | Score | Status |
|----------|-------|--------|
| ğŸš€ Performance | ${avgScores.performance}/100 | ${avgScores.performance >= 90 ? 'âœ…' : avgScores.performance >= 70 ? 'âš ï¸' : 'âŒ'} |
| â™¿ Accessibility | ${avgScores.accessibility}/100 | ${avgScores.accessibility >= 90 ? 'âœ…' : avgScores.accessibility >= 70 ? 'âš ï¸' : 'âŒ'} |
| ğŸ›¡ï¸ Best Practices | ${avgScores.bestPractices}/100 | ${avgScores.bestPractices >= 90 ? 'âœ…' : avgScores.bestPractices >= 70 ? 'âš ï¸' : 'âŒ'} |
| ğŸ” SEO | ${avgScores.seo}/100 | ${avgScores.seo >= 90 ? 'âœ…' : avgScores.seo >= 70 ? 'âš ï¸' : 'âŒ'} |
            
            ğŸ“Š Tested URLs: ${results.length}
            ğŸ”— [View detailed reports in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail if scores are below threshold
        run: |
          echo "Checking if all Lighthouse scores meet the minimum threshold..."
          # ã“ã®æ®µéšã§å¤±æ•—ã—ã¦ã„ã‚Œã°ã€ã‚¢ã‚µãƒ¼ãƒˆã§æ—¢ã«å¤±æ•—ã—ã¦ã„ã‚‹
          echo "âœ… All Lighthouse scores meet the required thresholds!"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚‚åŒæ™‚å®Ÿè¡Œ
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      
      - name: Security audit
        run: pnpm audit --audit-level moderate
      
      - name: Check for vulnerable packages
        run: |
          # è„†å¼±æ€§ã®ã‚ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          pnpm audit --json > audit-results.json || true
          
          # çµæœã‚’ç¢ºèª
          if [ -s audit-results.json ]; then
            echo "âš ï¸ Security vulnerabilities found!"
            cat audit-results.json
            exit 1
          else
            echo "âœ… No security vulnerabilities found!"
          fi